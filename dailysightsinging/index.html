<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sight Singing Practice</title>
    <link rel="icon" href="../icons/BGicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1c2439;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none; /* Disable text and image highlighting */
        }

        .container {
            margin-top: 150px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .reminders {
            width: 400px;
            border-radius: 10px;
            border: solid #6ec5d9a5;
            background-color: rgba(49, 129, 125, 0.543);
            padding: 0 10% 20px;
            margin-left: -10px;
        }

        h1 { margin: -70px 0 20px; }
        h2 { font-size: large; margin-bottom: 20px; }
        h3 {
            font-size: medium;
            margin-bottom: 20px;
            font-weight: 100;
            text-align: left;
        }

        .image-container {
            position: relative;
            top: 20px;
            width: 90%;
            margin: 20px auto;
        }

        img {
            width: 100%;
            height: auto;
            margin-bottom: 50px;
            filter: blur(10px);
            transition: filter 0.5s ease;
        }

        img.revealed { filter: blur(0); }

        input, button {
            margin: 10px auto;
            padding: 10px;
            background-color: #b4b4b4;
            color: #2f2f2f;
            border: none;
            border-radius: 4px;
        }

        #nameInput { width: 300px; }

        #recordButton {
            width: 60px;
            height: 60px;
            margin-top: -10px;
            margin-bottom: 35px;
            border-radius: 50%;
            background-color: #888888; /* Default gray color */
            cursor: not-allowed; /* Show not-allowed cursor when disabled */
        }

        #recordButton:not(:disabled) {
            background-color: #f44336; /* Red color when enabled */
            cursor: pointer;
        }

        #recordIcon {
            width: 20px;
            height: 20px;
            background-color: #ffffff;
            border-radius: 50%;
            margin: auto;
        }

        #recordIcon.recording {
            width: 14px;
            height: 14px;
            border-radius: 0;
        }

        #visualizer {
            width: 100%;
            height: 200px;
            background-color: #3c3c3c;
            margin: 10px auto;
            display: none;
        }

        #audioPlayback { 
            display: none; 
            margin-top: -10px;
            margin-bottom: 25px;
            width: 100%; }

        #downloadButton {
            display: none;
            background-color: #4c8baf;
            color: white;
            margin-bottom: 50px;
        }

        .time-restriction {
            font-size: 24px;
            margin: 20px 0;
        }

        .recording-notice {
            color: #ff9800;
            font-size: 16px;
            margin-top: -15px;
            margin-bottom: 35px;
            display: none;
        }

        /* Add styles for the modal */
        #passwordModal {
            position: fixed;
            z-index: 1000;
            width: 500px; /* Adjusted width for a smaller modal */
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            color: black; /* Change the password modal text color to black */
        }

        .modal-content {
            background-color: white;
            padding: 10px; /* Reduced padding for a smaller modal */
            border-radius: 5px;
            text-align: center;
        }

        #passwordInput {
            padding: 5px; /* Reduced padding for a smaller modal */
            width: 80%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Daily Sight Singing Practice</h1>
        <h2 id="dateSubtitle"></h2>
        <input type="text" id="nameInput" placeholder="Enter your name (required)" required>
        
        <div id="timeRestriction" class="time-restriction"></div>
        
        <div class="image-container">
            <img src="examples/1.jpg" alt="Sight Singing Exercise" id="exerciseImage" draggable="false">
        </div>
        
        <div id="countdown" style="display: none;"></div>
        <div id="recordingNotice" class="recording-notice">
            You may start recording at any time, but only may record once.
        </div>
        
        <button id="recordButton" disabled><div id="recordIcon"></div></button>
        <canvas id="visualizer"></canvas>
        <audio id="audioPlayback" controls></audio>
        <button id="downloadButton">Download Recording</button>
    </div>

    <div class="reminders">
        <h2><br>Some Reminders:</h2>
        <h3>
            <p>• Observe the key signature, first and last notes</p>
            <p>• Look for accidentals</p>
            <p>• Sing the scale before you start</p>
            <p>• Aim for accurate rhythms and consistency of tempo</p>
        </h3>
    </div>

    <div id="passwordModal" style="display: none;">
        <div class="modal-content">
            <span id="closeModal" style="cursor:pointer;"></span>
            <br>Enter Password
            <input type="password" id="passwordInput" placeholder="Password" />
            <button id="submitPassword">Submit</button>
        </div>
    </div>

    <script>
        // Disable right-click context menu
        document.addEventListener('contextmenu', (event) => {
            event.preventDefault();
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Calculate days since start date and determine current example
            const startDate = new Date('2024-11-04');
            const today = new Date();
            const differenceInTime = today.getTime() - startDate.getTime();
            const differenceInDays = Math.floor(differenceInTime / (1000 * 3600 * 24));
            const currentExample = (differenceInDays % 30) + 1; // Assuming 30 examples, loops back to 1

            // Update the image source with the current example number
            const exerciseImage = document.getElementById('exerciseImage');
            exerciseImage.src = `examples/${currentExample}.jpg`;

            // Display the current date
            const dateSubtitle = document.getElementById('dateSubtitle');
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const todayFormatted = today.toLocaleDateString('en-US', options);
            dateSubtitle.textContent = `${todayFormatted} (Exercise ${currentExample})`;
        });

        document.addEventListener('DOMContentLoaded', () => {
            const dateSubtitle = document.getElementById('dateSubtitle');
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const today = new Date().toLocaleDateString('en-US', options);
            dateSubtitle.textContent = today;
        });

        const allowedNames = [
            "Ben Chen", "Howard Ding", "Terry He", "Alice Li", "Vincent Mu",
            "Tiger Pan", "Chris Peng", "Lucy Sheng", "Diego Su", "Hailey Wang",
            "Eileen Xu", "Angelina Yan", "Serena Zeng", "Catherine Zhang",
            "Andrew Zhao", "Jennifer Zhou", "Ben", "Howard", "Terry", "Alice",
            "Vincent", "Tiger", "Chris", "Lucy", "Diego", "Hailey", "Eileen",
            "Angelina", "Serena", "Catherine", "Andrew", "Jennifer", "Mr. Tubbs"
        ];

        let mediaRecorder;
        let audioChunks = [];
        let audioContext;
        let analyser;
        let microphone;
        const recordButton = document.getElementById('recordButton');
        const nameInput = document.getElementById('nameInput');
        const visualizer = document.getElementById('visualizer');
        const audioPlayback = document.getElementById('audioPlayback');
        const downloadButton = document.getElementById('downloadButton');
        const exerciseImage = document.getElementById('exerciseImage');
        const countdownElement = document.getElementById('countdown');
        let animationId;
        let recordingStartTime;
        let countdownTimer;

        // Function to prevent right-click context menu
        const preventContextMenu = (event) => {
            event.preventDefault();
        };

        // Disable right-click context menu
        document.addEventListener('contextmenu', preventContextMenu);

        // Show custom password modal
        const showPasswordModal = () => {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('passwordInput').focus(); // Set focus on the password input
        };

        // Close modal
        document.getElementById('closeModal').onclick = () => {
            document.getElementById('passwordModal').style.display = 'none';
        };

        // Check if the image should remain unblurred
        const shouldUnblurImage = localStorage.getItem('unblurImage') === 'true';

        // Unblur the image if the flag is set
        if (shouldUnblurImage) {
            exerciseImage.classList.add('revealed');
        }

        // Handle password submission
        document.getElementById('submitPassword').onclick = () => {
            const password = document.getElementById('passwordInput').value;
            if (password === "review") {
                // Open the image in a new tab
                const exerciseImageSrc = document.getElementById('exerciseImage').src;
                window.open(exerciseImageSrc, '_blank'); // Open the image in a new tab
                recordButton.disabled = false; // Enable the record button
                document.getElementById('passwordModal').style.display = 'none'; // Close modal
            } else {
                alert("Incorrect password."); // Notify if password is wrong
            }
        };

        // Add event listener for pressing return key
        document.getElementById('passwordInput').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                document.getElementById('submitPassword').click(); // Trigger password submission
            }
        });

        // Modify the input event listener for nameInput
        nameInput.addEventListener('input', () => {
            const normalizedInput = nameInput.value.trim().toLowerCase();
            if (normalizedInput === "mr. tubbs") {
                showPasswordModal(); // Show custom password modal
            }
        });

        function isTimeToView() {
    const now = new Date();
    const startTime = new Date(now);
    startTime.setHours(10, 45, 0, 0);
    const endTime = new Date(now);
    endTime.setHours(10, 48, 0, 0);
    return now >= startTime && now <= endTime;
}

        function formatTimeRemaining(targetDate) {
    const now = new Date();
    let diff = targetDate - now;
    
    // Handle negative differences
    if (diff < 0) return "0m 0s";
    
    // Convert to positive number
    diff = Math.max(0, diff);
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    if (hours === 0) {
        return `${minutes}m ${seconds}s`;
    }
    return `${hours}h ${minutes}m ${seconds}s`;
}


function updateTimeRestriction() {
    const now = new Date();
    const todayStart = new Date(now);
    todayStart.setHours(10, 45, 0, 0);
    const todayEnd = new Date(now);
    todayEnd.setHours(10, 48, 0, 0);
    const finalEnd = new Date(now);
    finalEnd.setHours(11, 0, 0, 0);

    const tomorrowStart = new Date(now);
    tomorrowStart.setDate(now.getDate() + 1);
    tomorrowStart.setHours(10, 45, 0, 0);

    const timeRestrictionDiv = document.getElementById('timeRestriction');
    const recordingNotice = document.getElementById('recordingNotice');
    const exerciseImage = document.getElementById('exerciseImage');

    // Always start with disabled state
    recordButton.disabled = true;
    recordButton.style.backgroundColor = '#888888';
    recordButton.style.cursor = 'not-allowed';
    
    // Reset image blur state
    exerciseImage.classList.remove('revealed');

    if (now < todayStart) {
        // Before start time
        timeRestrictionDiv.textContent = `Today's example will go live in: ${formatTimeRemaining(todayStart)}`;
        recordingNotice.style.display = 'none';
    } else if (now >= todayStart && now <= todayEnd) {
        // During allowed window
        const normalizedInput = nameInput.value.trim().toLowerCase();
        const isNameAllowed = allowedNames.some(name => name.toLowerCase() === normalizedInput);
        
        timeRestrictionDiv.textContent = `Time remaining: ${formatTimeRemaining(todayEnd)}`;
        recordingNotice.style.display = 'block';
        
        if (isNameAllowed) {
            recordButton.disabled = false;
            recordButton.style.backgroundColor = '#f44336';
            recordButton.style.cursor = 'pointer';
            exerciseImage.classList.add('revealed'); // Unblur the image
        }
    } else if (now > todayEnd && now < finalEnd) {
        // After allowed window but before final end
        timeRestrictionDiv.innerHTML = `Please bring your recording in for peer review!`;
        recordingNotice.style.display = 'none';
    } else {
        // After final end
        timeRestrictionDiv.textContent = `Tomorrow's example will go live in: ${formatTimeRemaining(tomorrowStart)}`;
        recordingNotice.style.display = 'none';
    }

    setTimeout(updateTimeRestriction, 1000);
}

document.addEventListener('DOMContentLoaded', () => {
    updateTimeRestriction();
    
    nameInput.addEventListener('input', () => {
        const normalizedInput = nameInput.value.trim().toLowerCase();
        const isNameAllowed = allowedNames.some(name => name.toLowerCase() === normalizedInput);
    });

            let isRecording = false;
let recordingTimeout;
let hasRecordedToday = false;
let recordingStartTime;

recordButton.onclick = async () => {
    // Check if already recorded today
    if (hasRecordedToday) {
        return;
    }

    if (!isRecording) {
        // Start recording
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        analyser.fftSize = 256;

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.style.display = 'block';
            downloadButton.style.display = 'block';
            visualizer.style.display = 'none';
            recordButton.style.backgroundColor = '#888888';
            recordButton.style.cursor = 'not-allowed';
            recordButton.disabled = true;
            convertToMp3();
            
            // Reset recording state and disable further recording
            isRecording = false;
            hasRecordedToday = true;
            document.getElementById('recordIcon').classList.remove('recording');
            recordButton.style.backgroundColor = '#888888'; // Gray out the button
            recordButton.disabled = true; // Disable the button
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
            }

            // Update recording notice
            const recordingNotice = document.getElementById('recordingNotice');
            recordingNotice.textContent = 'Recording complete.';
            recordingNotice.style.color = '#4CAF50'; // Change to green to indicate completion
        };
        audioChunks = [];
        mediaRecorder.start();
        recordingStartTime = Date.now();
        recordButton.style.backgroundColor = '#32CD32';
        visualizer.style.display = 'block';
        drawVisualization();
        clearInterval(countdownTimer);
        countdownElement.style.display = 'none';
        
        // Update recording state
        isRecording = true;
        document.getElementById('recordIcon').classList.add('recording');

        // Set timeout for end of recording period
        const now = new Date();
        const todayEnd = new Date(now);
        todayEnd.setHours(10, 48, 0, 0);
        const timeUntilEnd = todayEnd - now;
        if (timeUntilEnd > 0) {
            recordingTimeout = setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            }, timeUntilEnd);
        }
    } else {
        // Stop recording only if 5 seconds have elapsed
        const recordingDuration = Date.now() - recordingStartTime;
        if (recordingDuration >= 5000) { // 5000 milliseconds = 5 seconds
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                cancelAnimationFrame(animationId);
            }
        } else {
            // Optionally notify the user that they need to wait
            const recordingNotice = document.getElementById('recordingNotice');
            recordingNotice.textContent = 'Keep going!';
            recordingNotice.style.color = '#ff9800'; // Orange color for warning
        }
    }
};

        function drawVisualization() {
            const canvas = visualizer;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = '#3c3c3c';
            ctx.fillRect(0, 0, width, height);

            const barWidth = width / bufferLength * 2.5;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }

            animationId = requestAnimationFrame(drawVisualization);
        }

        function convertToMp3() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const fileReader = new FileReader();

            fileReader.onload = function(event) {
                const arrayBuffer = event.target.result;
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                    const channelData = audioBuffer.getChannelData(0);
                    const mp3encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
                    const mp3Data = [];

                    const sampleBlockSize = 1152;
                    for (let i = 0; i < channelData.length; i += sampleBlockSize) {
                        const sampleChunk = channelData.subarray(i, i + sampleBlockSize);
                        const int16SampleChunk = new Int16Array(sampleChunk.length);
                        for (let j = 0; j < sampleChunk.length; j++) {
                            int16SampleChunk[j] = Math.max(-1, Math.min(1, sampleChunk[j])) * 0x7FFF;
                        }
                        const mp3buf = mp3encoder.encodeBuffer(int16SampleChunk);
                        if (mp3buf.length > 0) {
                            mp3Data.push(mp3buf);
                        }
                    }

                    const mp3buf = mp3encoder.flush();
                    if (mp3buf.length > 0) {
                        mp3Data.push(mp3buf);
                    }

                    const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
                    downloadButton.onclick = () => {
                        const fileName = generateFileName();
                        const url = URL.createObjectURL(mp3Blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    };
                });
            };

            fileReader.readAsArrayBuffer(audioBlob);
        }


        function generateFileName() {
            const name = nameInput.value.trim().replace(/[^a-z0-9]/gi, '_');
            const date = recordingStartTime.toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-');
            return `${name}_${date}.mp3`;
        }

        // Close modal when clicking outside of it
        window.onclick = (event) => {
            const modal = document.getElementById('passwordModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Close modal when pressing the Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                document.getElementById('passwordModal').style.display = 'none';
            }
        });
    }); 
    </script>
</body>
</html>